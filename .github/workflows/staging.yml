name: Deploy Staging
on:
  pull_request:
    branches:
      - main
jobs:
  deploy:
    if: github.event.action == 'opened'
    name: Deploy app
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate Environment Name
        id: generate-env-name
        run: echo "env_name=bnsn-pr-${{ github.event.number }}" >> $GITHUB_ENV
      
      - name: Create new environment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          ENV_NAME="bnsn-pr-${{ github.event.number }}"
        
          # Create the environment
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/environments \
            -d "{\"name\":\"$ENV_NAME\"}"
          
          echo "Environment $ENV_NAME created for PR #$PR_NUMBER"


           
      

    
  # cleanup_environment:
  #   if: github.event.action == 'closed' || github.event.pull_request.merged == true
  #   runs-on: ubuntu-latest
  #   steps:
      #- name: Set up Flyctl
      #  uses: superfly/flyctl-actions/setup-flyctl@master

      # - name: Generate Environment Name
      #   id: generate-env-name
      #   run: echo "env_name=bnsn-pr-${{ github.event.number }}" >> $GITHUB_ENV